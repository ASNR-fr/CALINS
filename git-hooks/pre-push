#!/bin/bash

# Pre-push git hook: Update version before pushing
# This script generates and updates the version number based on the current commit hash and date

# Get the current branch being pushed
read local_ref local_sha remote_ref remote_sha
branch=$(git rev-parse --abbrev-ref HEAD)

# Only update version on main/master branches
if [[ "$branch" == "main" ]] || [[ "$branch" == "master" ]]; then
    echo "ðŸ“ Updating version before push on branch: $branch"
    
    # Read base version from version.py
    if [ -f "calins/src/version.py" ]; then
        fullVersion=$(grep -oP '__version__\s*=\s*"\K[^"]+' calins/src/version.py)
        baseVersion=${fullVersion%%.dev*}
    else
        echo "âŒ Error: calins/src/version.py not found"
        exit 1
    fi
    
    # Get git hash and date
    hash=$(git rev-parse --short HEAD)
    date=$(date +%Y%m%d)
    
    # Build complete version
    version="${baseVersion}.dev0+${hash}.${date}"
    
    # Write to version.py
    cat > calins/src/version.py << EOF
"""Version file - automatically generated."""
__version__ = "$version"
EOF
    
    echo "âœ… Generated version: $version"
    
    # Stage and commit the changes
    git add calins/src/version.py
    
    # Check if there are changes to commit
    if ! git diff-index --quiet --cached HEAD --; then
        git commit -m "chore: update version"
        echo "âœ… Version committed"
    fi
fi

exit 0
