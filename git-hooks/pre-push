#!/bin/bash

# Pre-push git hook: Update version before pushing and amend the last commit
# This modifies the version.py file with the correct hash and amends the last commit
# No extra commit is created - the version change is added to the existing commit

if [ -f "calins/src/version.py" ]; then
    # Read base version from version.py
    fullVersion=$(grep -oP '__version__\s*=\s*"\K[^"]+' calins/src/version.py)
    baseVersion=${fullVersion%%.dev*}
    
    # Get git hash and date (now HEAD exists with the real commit hash)
    hash=$(git rev-parse --short HEAD)
    date=$(date +%Y%m%d)
    
    # Build complete version
    version="${baseVersion}.dev0+${hash}.${date}"
    
    # Write to version.py
    cat > calins/src/version.py << EOF
"""Version file - automatically generated."""
__version__ = "$version"
EOF
    
    echo "ðŸ“ Version updated: $version"
    
    # Check if there are changes to stage
    if ! git diff --quiet calins/src/version.py; then
        # Stage the version change
        git add calins/src/version.py
        
        # Amend the last commit with the version change (no new commit)
        git commit --amend --no-edit
        echo "âœ… Last commit amended with version"
    fi
else
    echo "âŒ Error: calins/src/version.py not found"
    exit 1
fi

exit 0
